# Описание решения

Данное решение предназначено для изменения оффсета последней обработанной транзакции в Debezium с использованием коннектора к базе данных PostgreSQL. Оно включает в себя несколько скриптов, которые взаимодействуют с Kafka и PostgreSQL для управления оффсетами и обработки сообщений.

## Описание скриптов

### 1. `get-connectors-offsets-from-commit-offsets-topic.sh`

Этот скрипт использует `kafka-console-consumer.sh` для чтения сообщений из топика Kafka `connect_offsets`. Он обрабатывает сообщения, содержащие информацию о транзакциях, и выводит их в формате JSON. Скрипт извлекает ключевые поля, такие как `connector`, `server`, `txId`, `lsn`, `lsn_commit`, и `ts_usec`. Предназначен для формирования файла, который содержит актуальные идентификаторы транзакций и смещения из топика `connect_offsets`. После чего из этого файла можно получить файл, содержащий только последние записи для каждого коннектора при помощи скрипта `group-and-sort-connector-offsets.sh`.

### 2. `get-connectors-offsets-from-replication-slots.sh`

Этот скрипт выполняет SQL-запрос в контейнере PostgreSQL для получения информации о слотах репликации. Он извлекает данные о коннекторах, таких как `connector`, `server`, `txId`, `lsn_commit`, и `lsn`, и выводит их в формате JSON. Этот файл можно подать на вход скрипту `restart-messages-from-lsn-from-file.sh` или `restart-messages-from-beginning-from-file.sh` для повторной отправки сообщений из WAL в Kafka.

### 3. `restart-messages-from-beginning-from-file.sh`

Этот скрипт читает строки из файла `connectors.data` и для каждой строки вызывает скрипт `restart-messages-from-beginning.sh`. Он используется для повторной отправки сообщений в Kafka, при этом отправятся все сообщения, начиная с начала WAL.

### 4. `restart-messages-from-beginning.sh`

Этот скрипт отправляет сообщение в топик Kafka `connect_offsets`, используя `kafka-console-producer.sh`. Он отправляет сообщение с уникальным ключом для коннектора и пустым телом, что означает, что все транзакции должны быть прочитаны заново.

### 5. `restart-messages-from-lsn-from-file.sh`

Этот скрипт читает строки из файла и для каждой строки вызывает скрипт `restart-messages-from-lsn.sh`. Он используется для повторной отправки сообщений в Kafka, начиная с определенного LSN (Log Sequence Number).

### 6. `restart-messages-from-lsn.sh`

Этот скрипт отправляет сообщение в топик Kafka `connect_offsets`, используя `kafka-console-producer.sh`. Он формирует ключ и значение сообщения на основе полей `connector`, `server`, `txId`, `lsn_commit`, и `lsn` из входного JSON и отправляет его в Kafka. Предназначен для повторной отправки всех сообщений, начиная с определенного LSN.

## Формат файла `connectors.data`

Файл `connectors.data` содержит JSON-строки, каждая из которых представляет собой информацию о транзакции. Пример строки:

```json
{"connector" : "outbox-connector", "server" : "dbserver1", "txId" : "552", "lsn_commit" : 24126992, "lsn" : 24139720}
```

Каждая строка содержит следующие поля:
- `connector`: имя коннектора
- `server`: имя сервера
- `txId`: идентификатор транзакции
- `lsn_commit`: LSN коммита
- `lsn`: LSN

Эти данные используются для управления оффсетами и повторной отправки сообщений в Kafka. Файл должен обязательно заканчиваться пустой строкой.

## Разработка

Если требуется изменить скрипты и провести тестирование, то необходимо запустить контейнеры при помощи команды `docker compose up -d`. И далее воспользоваться скриптами:

### `create-connector.sh`

Этот скрипт используется для создания нового коннектора в Kafka Connect. Он отправляет POST-запрос с данными из файла `outbox-connector.json` на сервер Kafka Connect.

### `delete-connector.sh`

Этот скрипт удаляет существующий коннектор из Kafka Connect. Он отправляет DELETE-запрос на сервер Kafka Connect для указанного имени коннектора.

### `status-connector.sh`

Этот скрипт запрашивает статус указанного коннектора в Kafka Connect. Он отправляет GET-запрос на сервер Kafka Connect и выводит статус коннектора в формате JSON.

### `insert-test-data.sh`

Этот скрипт используется для добавления тестовых данных в таблицу `outbox` базы данных PostgreSQL. Он выполняет SQL-скрипт внутри контейнера PostgreSQL, используя параметры подключения к базе данных. Скрипт проверяет статус выполнения и выводит сообщение об успешном добавлении данных или об ошибке.
